<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Dashboard Pub/Sub</title>

  <style>
    body {
      margin: 0; padding: 0;
      background: #ececec;
      font-family: system-ui, sans-serif;
    }

    h3 { margin: 0 0 8px 0; }

    /* ---- GRID DE PANELES ---- */
    #grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 12px;
      padding: 12px;
    }

    .panel {
      background: #fff;
      padding: 12px;
      border-radius: 10px;
      box-shadow: 0px 2px 6px #0002;
    }

    /* ---- LOG ---- */
    #log {
      background: #111;
      color: #0f0;
      height: 200px;
      overflow-y: auto;
      border-radius: 6px;
      padding: 10px;
      white-space: pre-wrap;
      font-family: monospace;
    }

    /* ---- TOPIC FILTER BUTTONS ---- */
    .topic-btn {
      padding: 4px 8px;
      background: #ccc;
      border-radius: 6px;
      border: none;
      margin: 2px;
      cursor: pointer;
      font-size: 0.8rem;
    }
    .topic-btn.active {
      background: #4caf50;
      color: white;
    }

    /* ---- CANVAS CAMERA ---- */
    #cam {
      border: 1px solid #555;
      image-rendering: pixelated;
      width: 260px;
      height: 320px;
    }

    input, button, textarea {
      margin: 4px 0;
      width: 100%;
      padding: 6px;
      box-sizing: border-box;
      font-size: 1rem;
    }

    textarea {
      height: 80px;
      resize: vertical;
    }
  </style>
</head>


<body>
  <div id="grid">

    <!-- ========================================================= -->
    <!-- PANEL 1: CONEXIÃ“N WS -->
    <!-- ========================================================= -->
    <section class="panel" id="panel-connection">
      <h3>ConexiÃ³n WebSocket</h3>

      <label>IP del Broker:</label>
      <input id="ip" value="192.168.1.3">

      <label>Puerto:</label>
      <input id="port" value="5052">

      <button id="btnConnect">Conectar</button>
      <button id="btnDisconnect" disabled>Desconectar</button>

      <p id="status">Desconectado</p>
    </section>
 <script>
  /* ============================================================
     CLIENTE WEBSOCKET
  ============================================================ */
  let ws = null;

  const statusBox = document.getElementById("status");
  const btnConnect = document.getElementById("btnConnect");
  const btnDisconnect = document.getElementById("btnDisconnect");

  btnConnect.onclick = () => {
    const ip = document.getElementById("ip").value;
    const port = document.getElementById("port").value;

    const url = `ws://${ip}:${port}/ws`;
    logBox.textContent += `Intentando conectar a ${url}\n`;

    ws = new WebSocket(url);
    ws.binaryType = "arraybuffer";

    ws.onopen = () => {
      statusBox.textContent = "ðŸŸ¢ Conectado";
      btnConnect.disabled = true;
      btnDisconnect.disabled = true;
      addLog("debug", "WS conectado");
    };

    ws.onclose = () => {
      statusBox.textContent = "ðŸ”´ Desconectado";
      btnConnect.disabled = false;
      btnDisconnect.disabled = true;
      addLog("debug", "WS cerrado");
    };

    ws.onerror = (e) => {
      addLog("debug", "WS error: " + e.message);
    };

    ws.onmessage = (ev) => {
        try {
            msg = JSON.parse(ev.data);
        } catch (e) {
            console.error("JSON invÃ¡lido:", e);
            return;
        }     
        bus.publish(msg.topic, msg.data);
    };
  };

  btnDisconnect.onclick = () => {
    if (ws) ws.close();
  };

  </script>

    <!-- ========================================================= -->
    <!-- PANEL 2: ENVÃO DE MENSAJES -->
    <!-- ========================================================= -->
    <section class="panel" id="panel-messages">
      <h3>Mensajes</h3>

      <label>Prefijo del tÃ³pico</label>
      <input id="topicPrefix" value="UDFJC/emb1/robot0">


      <label>TÃ³pico</label>
      <input id="msgTopic" value="RPi/sequence">

      <label>Payload JSON</label>
      <textarea id="msgPayload">{
  "action": "execute_now",
  "name": "ymca"
}
</textarea>

      <button id="btnPub">Publicar</button>
      <button id="btnSub">Suscribir</button>
    </section>

  <script>
/* ============================================================
   FUNCIÃ“N DE COMPARACIÃ“N DE TÃ“PICOS (wildcards estilo MQTT)
   ============================================================ */
function compareTopics(pattern, topic) {
    const p = pattern.split('/');
    const t = topic.split('/');

    for (let i = 0; i < p.length; i++) {

        // '#' coincide con cualquier cantidad de niveles (solo final)
        if (p[i] === '#') return true;

        // '+' coincide con exactamente un nivel
        if (p[i] === '+') {
            if (i >= t.length) return false;
            continue;
        }

        // Si el patrÃ³n es mÃ¡s largo que el tÃ³pico â†’ no coincide
        if (i >= t.length) return false;

        // comparaciÃ³n exacta
        if (p[i] !== t[i]) return false;
    }

    // Si sobraron niveles en el tÃ³pico â†’ no coincide
    return p.length === t.length;
}


/* ============================================================
   PUBSUB LOCAL CON WILDCARDS
   ============================================================ */
class PubSub {
    constructor() { this.subs = {}; }

    subscribe(pattern, cb) {
        if (!this.subs[pattern]) this.subs[pattern] = [];
        this.subs[pattern].push(cb);
    }

    publish(topic, message) {
        for (const pattern in this.subs) {
            if (compareTopics(pattern, topic)) {
                this.subs[pattern].forEach(cb => cb(message, topic));
            }
        }

        // subscripciÃ³n global '*'
        if (this.subs["*"]) {
            this.subs["*"].forEach(cb => cb(topic, message));
        }
    }
}

const bus = new PubSub();
function read_prefix() {
    // Declarar variable local (evitar global implÃ­cita)
    let prefix = document.getElementById("topicPrefix").value.trim();
    
    // Asegurar formato correcto
    if (prefix.endsWith('/')) prefix = prefix.slice(0, -1);

    return prefix;
}

// Inicializar prefix del bus
bus.prefix = read_prefix();

// Actualizar el prefix cuando cambie el input
document.getElementById("topicPrefix").onchange = () => {
    bus.prefix = read_prefix();
};


/* ============================================================
   EXTENSIONES DEL BUS: API PUB / SUB PARA TODA LA PÃGINA
   ============================================================ */

bus.pub = function (topic, message) {
    // PublicaciÃ³n local
    bus.publish(topic, message);

    // Enviar al WebSocket si estÃ¡ activo
    if (ws && ws.readyState === WebSocket.OPEN) {
        const obj = { action: "PUB", topic, data: message };
        ws.send(JSON.stringify(obj));
        addLog(topic, "PUB â†’ WS");
    } else {
        addLog(topic, "PUB (solo local, WS no conectado)");
    }
};

bus.pub_pre = function (sufijo, message) {
    //const prefix = document.getElementById("topicPrefix").value.trim();
    bus.pub(bus.prefix+'/'+sufijo,message)
};

bus.sub = function (topic, callback) {
    // SuscripciÃ³n local con wildcards
    bus.subscribe(topic, callback);
    addLog(topic, "SUB local registrado");

    // SuscripciÃ³n remota por WebSocket
    if (ws && ws.readyState === WebSocket.OPEN) {
        const obj = { action: "SUB", topic };
        ws.send(JSON.stringify(obj));
        addLog(topic, "SUB â†’ WS enviado");
    } else {
        addLog(topic, "SUB (solo local, WS no conectado)");
    }
};

bus.sub_pre = function (sufijo, callback) {
    //const prefix = document.getElementById("topicPrefix").value.trim();
    bus.sub(bus.prefix+'/'+sufijo,callback)
};
/* ============================================================
   BOTONES PUB / SUB (actualizados para usar bus.pub y bus.sub)
   ============================================================ */

document.getElementById("btnPub").onclick = () => {
    const prefix = document.getElementById("topicPrefix").value.trim();
    const sufix = document.getElementById("msgTopic").value;
    const topic = `${prefix}/${sufix}`;
    const data = JSON.parse(document.getElementById("msgPayload").value);

    bus.pub(topic, data);
};

document.getElementById("btnSub").onclick = () => {
    const prefix = document.getElementById("topicPrefix").value.trim();
    const sufix = document.getElementById("msgTopic").value;
    const topic = `${prefix}/${sufix}`;

    bus.sub(topic, (msg, t) => {
        addLog(t, "SUB recibiÃ³ mensaje");
    });
};

  </script>
    <!-- ========================================================= -->
    <!-- PANEL 3: LOG CON FILTROS -->
    <!-- ========================================================= -->
    <section class="panel" id="panel-log">
      <h3>Log</h3>

      <div id="filters"></div>
      <pre id="log"></pre>
    </section>
<script>
  /* ============================================================
     LOG + FILTRO
  ============================================================ */
  const logBox = document.getElementById("log");
  const filtersDiv = document.getElementById("filters");
  const topicButtons = {};
  let visibleTopics = new Set();

  function addTopicButton(topic) {
    if (topicButtons[topic]) return;
    visibleTopics.add(topic);

    const btn = document.createElement("button");
    btn.className = "topic-btn active";
    btn.textContent = topic;
    btn.onclick = () => {
      const active = btn.classList.toggle("active");
      if (active) visibleTopics.add(topic);
      else visibleTopics.delete(topic);
    };

    filtersDiv.appendChild(btn);
    topicButtons[topic] = btn;
  }

  function addLog(topic, txt) {
    if (!topicButtons[topic]) addTopicButton(topic);
    if (!visibleTopics.has(topic)) return;

    logBox.textContent += `[${topic}] ${txt}\n`;
    logBox.scrollTop = logBox.scrollHeight;
  }

  bus.subscribe("*", (topic, msg) => {
    //console.log('bus.subscribe',msg)
    if (typeof msg === 'object'){
        addLog(topic,  Object.keys(msg) );
    }
    else {
        addLog(topic, msg );
    }
  });
 
  </script>

    <!-- ========================================================= -->
    <!-- PANEL 4: VISUALIZADOR DE CÃMARA -->
    <!-- ========================================================= -->
    <section class="panel" id="panel-camera">
      <h3>CÃ¡mara (camera/frame)</h3>

      <canvas id="cam" width="160" height="120"></canvas>
      <p id="camInfo"></p>
    </section>


  <script>
  /* ============================================================
     VISUALIZADOR DE CÃMARA (camera/frame con RGB565)
  ============================================================ */
  const canvas = document.getElementById("cam");
  const ctx = canvas.getContext("2d");
  const W = 160, H = 120;
  const camera_prefix = document.getElementById("topicPrefix").value.trim();

bus.subscribe(camera_prefix+"/camera/frame", (payload) => {
    let msg=payload;

    const w = msg.w;
    const h = msg.h;
    const b64 = msg.frame_b64;

    // --- Decodificar base64 a Uint8Array ---
    const binary = atob(b64);      // decodifica base64 â†’ string binario
    const u8 = new Uint8Array(binary.length);

    for (let i = 0; i < binary.length; i++) {
        u8[i] = binary.charCodeAt(i);
    }

    // --- Convertir RGB565 â†’ RGBA ---
    const img = ctx.createImageData(w, h);
    const data = img.data;

    for (let i = 0; i < u8.length; i += 2) {
        const rgb565 = (u8[i] << 8) | u8[i+1];
        const r = ((rgb565 >> 11) & 0x1F) << 3;
        const g = ((rgb565 >> 5) & 0x3F) << 2;
        const b = (rgb565 & 0x1F) << 3;

        const idx = (i >> 1) * 4;
        data[idx]   = r;
        data[idx+1] = g;
        data[idx+2] = b;
        data[idx+3] = 255;
    }

    ctx.putImageData(img, 0, 0);

    document.getElementById("camInfo").textContent =
        `Frame RGB565 ~ ${u8.length} bytes (${w}x${h})`;
});


  </script>

    <!-- ========================================================= -->
    <!-- PANEL 5: Gemelo Virtual -->
    <!-- ========================================================= -->
    <section class="panel" id="panel-gemelo">
      <h3>Gemelo</h3>
      <input id="coreoName" value="ymca">
      <button id="btnStartCoreo">Iniciar CoreografÃ­a</button>
      <div id="render1" style="width:100%; height:300px;"></div>
      <!--canvas id="canvas-gemelo" width="130" height="130"></canvas-->
      <!--p id="camInfo"></p-->
    </section>



  <script type="module">
  /* ============================================================
     Gemelo virtual
  ============================================================ */
//   const canvas_gemelo = document.getElementById("canvas-gemelo");
//   const ctx_gemelo = canvas_gemelo.getContext("2d");

// bus.subscribe("UDFJC/emb1/robot0/RPi/state", (payload) => {
//  });

// bus.subscribe("UDFJC/emb1/robot0/RPi/sequence", (payload) => {
//  });


import { CorridorScene } from "./3D/CorridorScene.js";
import { RoDifArm } from "./3D/RoDifArm.js";

const world = new CorridorScene(document.getElementById("render1"));
///////////////////// Robots
const n_bots =10
const n_robot = 0
//const bus=null

const robot = new RoDifArm(world, bus, { x: (n_robot - n_bots / 2) * 5, y: 0 });

document.getElementById("btnStartCoreo").onclick = () => {

    const name = document.getElementById("coreoName").value.trim();
    const coreo = name === "" ? "ymca" : name;
    //console.log('paner_twin',coreo)
    //robot.runSequence(coreo);

    // const msg = {
    //     action: "PUB",
    //     topic: camera_prefix+"/RPi/sequence",
    //     data: {
    //         "action": "execute_now",
    //         "name": coreo
    //         }
    // };

    bus.pub_pre("RPi/sequence", {
            "action": "execute_now",
            "name": coreo
            });

    // document.getElementById("coreoStatus").textContent =
    //   `CoreografÃ­a enviada: ${coreo}`;
};



//   bus.sub_pre("/RPi/sequence", (topic, msg) => {
//     console.log('bus.subscribe',msg)
//     if (typeof msg === 'object'){
//         addLog(topic,  Object.keys(msg) );
//     }
//     else {
//         addLog(topic, msg );
//     }
//   });

    // const beat = 1;
    // const n_beats = 5;
    // const tiempo = n_beats * beat;
    // const d = 1;
    // const R = 2.5;
    // const omega = Math.PI / tiempo;
    // const vel_lin = omega * R;

    // const sequences = {"ymca":[
    //       { v: 1, w: 0, alpha0: 0, time: 2 },
    //       { v: 0, w: -Math.PI / 4, alpha0: -Math.PI / 2, alpha1: 0, time: 2 },
    //       { v: vel_lin, w: omega, time: tiempo },
    //       {
    //         v: 0,
    //         w: 0,
    //         alpha0: Math.PI / 2,
    //         alpha1: (6 * Math.PI) / 16,
    //         alpha2: -(6 * Math.PI) / 16,
    //         time: 2,
    //       },
    //       { v: -vel_lin, w: omega, time: tiempo },
    //       { v: 1, w: 0, alpha0: 0, time: 2 },
    //       {
    //         v: 0,
    //         w: -Math.PI / 4,
    //         alpha0: Math.PI / 2,
    //         alpha1: (6 * Math.PI) / 16,
    //         alpha2: -(6 * Math.PI) / 16,
    //         time: 2,
    //       },
    //       { v: -vel_lin, w: omega, time: tiempo },
    //       { v: 0, w: 0, alpha0: -Math.PI / 2, alpha1: 0, alpha2: 0, time: 2 },
    //       { v: vel_lin, w: omega, time: tiempo },        
    //     ]};





    function coreografia(){
      music.volume = 0.7;
      music.currentTime = 0; 
      music.play().then(() => {
        console.log("MÃºsica iniciada");
        console.log("ðŸŽµ DuraciÃ³n total:", music.duration, "segundos");
      }).catch(err => console.warn("Error al reproducir:", err));
      setTimeout(() => music.pause(), 16000);
      set_sequences()
    }



  </script>




   </div>
 
</body>
</html>

