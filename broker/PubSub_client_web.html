<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Dashboard Pub/Sub</title>

  <style>
    body {
      margin: 0; padding: 0;
      background: #ececec;
      font-family: system-ui, sans-serif;
    }

    h3 { margin: 0 0 8px 0; }

    /* ---- GRID DE PANELES ---- */
    #grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 12px;
      padding: 12px;
    }

    .panel {
      background: #fff;
      padding: 12px;
      border-radius: 10px;
      box-shadow: 0px 2px 6px #0002;
    }

    /* ---- LOG ---- */
    #log {
      background: #111;
      color: #0f0;
      height: 200px;
      overflow-y: auto;
      border-radius: 6px;
      padding: 10px;
      white-space: pre-wrap;
      font-family: monospace;
    }

    /* ---- TOPIC FILTER BUTTONS ---- */
    .topic-btn {
      padding: 4px 8px;
      background: #ccc;
      border-radius: 6px;
      border: none;
      margin: 2px;
      cursor: pointer;
      font-size: 0.8rem;
    }
    .topic-btn.active {
      background: #4caf50;
      color: white;
    }

    /* ---- CANVAS CAMERA ---- */
    #cam {
      border: 1px solid #555;
      image-rendering: pixelated;
      width: 260px;
      height: 320px;
    }

    input, button, textarea {
      margin: 4px 0;
      width: 100%;
      padding: 6px;
      box-sizing: border-box;
      font-size: 1rem;
    }

    textarea {
      height: 80px;
      resize: vertical;
    }
  </style>
</head>


<body>
  <div id="grid">

    <!-- ========================================================= -->
    <!-- PANEL 1: CONEXIÃ“N WS -->
    <!-- ========================================================= -->
    <section class="panel" id="panel-connection">
      <h3>ConexiÃ³n WebSocket</h3>

      <label>IP del Broker:</label>
      <input id="ip" value="192.168.1.3">

      <label>Puerto:</label>
      <input id="port" value="5052">

      <button id="btnConnect">Conectar</button>
      <button id="btnDisconnect" disabled>Desconectar</button>

      <p id="status">Desconectado</p>
    </section>
 <script>
  /* ============================================================
     CLIENTE WEBSOCKET
  ============================================================ */
  let ws = null;

  const statusBox = document.getElementById("status");
  const btnConnect = document.getElementById("btnConnect");
  const btnDisconnect = document.getElementById("btnDisconnect");

  btnConnect.onclick = () => {
    const ip = document.getElementById("ip").value;
    const port = document.getElementById("port").value;

    const url = `ws://${ip}:${port}/ws`;
    logBox.textContent += `Intentando conectar a ${url}\n`;

    ws = new WebSocket(url);
    ws.binaryType = "arraybuffer";

    ws.onopen = () => {
      statusBox.textContent = "ðŸŸ¢ Conectado";
      btnConnect.disabled = true;
      btnDisconnect.disabled = true;
      addLog("debug", "WS conectado");
    };

    ws.onclose = () => {
      statusBox.textContent = "ðŸ”´ Desconectado";
      btnConnect.disabled = false;
      btnDisconnect.disabled = true;
      addLog("debug", "WS cerrado");
    };

    ws.onerror = (e) => {
      addLog("debug", "WS error: " + e.message);
    };

    ws.onmessage = (ev) => {
        try {
            msg = JSON.parse(ev.data);
        } catch (e) {
            console.error("JSON invÃ¡lido:", e);
            return;
        }     
        bus.publish(msg.topic, msg.data);
    };
  };

  btnDisconnect.onclick = () => {
    if (ws) ws.close();
  };

  </script>

    <!-- ========================================================= -->
    <!-- PANEL 2: ENVÃO DE MENSAJES -->
    <!-- ========================================================= -->
    <section class="panel" id="panel-messages">
      <h3>Mensajes</h3>

      <label>TÃ³pico</label>
      <input id="msgTopic" value="debug/msg">

      <label>Payload JSON</label>
      <textarea id="msgPayload">{ "hello": "world" }</textarea>

      <button id="btnPub">Publicar</button>
      <button id="btnSub">Suscribir</button>
    </section>

  <script>
  /* ============================================================
     PUBSUB LOCAL
  ============================================================ */
  class PubSub {
    constructor() { this.subs = {}; }
    subscribe(topic, cb) {
      if (!this.subs[topic]) this.subs[topic] = [];
      this.subs[topic].push(cb);
    }
    publish(topic, message) {
      if (this.subs[topic]) this.subs[topic].forEach(cb => cb(message));
      if (this.subs["*"])    this.subs["*"].forEach(cb => cb(topic, message));
    }
  }
  const bus = new PubSub();

  </script>
   <script>
  /* ============================================================
     BOTONES PUB / SUB
  ============================================================ */
  document.getElementById("btnPub").onclick = () => {
    if (!ws || ws.readyState != 1) return alert("WS no conectado");

    const topic = document.getElementById("msgTopic").value;
    const data = JSON.parse(document.getElementById("msgPayload").value);

    const obj = { action: "PUB", topic, data };
    ws.send(JSON.stringify(obj));
    addLog(topic, "PUB enviado");
  };

  document.getElementById("btnSub").onclick = () => {
    if (!ws || ws.readyState != 1) return alert("WS no conectado");

    const topic = document.getElementById("msgTopic").value;
    const obj = { action: "SUB", topic };
    ws.send(JSON.stringify(obj));
    addLog(topic, "SUB enviado");
  };

  </script>
    <!-- ========================================================= -->
    <!-- PANEL 3: LOG CON FILTROS -->
    <!-- ========================================================= -->
    <section class="panel" id="panel-log">
      <h3>Log</h3>

      <div id="filters"></div>
      <pre id="log"></pre>
    </section>
<script>
  /* ============================================================
     LOG + FILTRO
  ============================================================ */
  const logBox = document.getElementById("log");
  const filtersDiv = document.getElementById("filters");
  const topicButtons = {};
  let visibleTopics = new Set();

  function addTopicButton(topic) {
    if (topicButtons[topic]) return;
    visibleTopics.add(topic);

    const btn = document.createElement("button");
    btn.className = "topic-btn active";
    btn.textContent = topic;
    btn.onclick = () => {
      const active = btn.classList.toggle("active");
      if (active) visibleTopics.add(topic);
      else visibleTopics.delete(topic);
    };

    filtersDiv.appendChild(btn);
    topicButtons[topic] = btn;
  }

  function addLog(topic, txt) {
    if (!topicButtons[topic]) addTopicButton(topic);
    if (!visibleTopics.has(topic)) return;

    logBox.textContent += `[${topic}] ${txt}\n`;
    logBox.scrollTop = logBox.scrollHeight;
  }

  bus.subscribe("*", (topic, msg) => {
    addLog(topic,  Object.keys(msg) );
  });

  </script>

    <!-- ========================================================= -->
    <!-- PANEL 4: VISUALIZADOR DE CÃMARA -->
    <!-- ========================================================= -->
    <section class="panel" id="panel-camera">
      <h3>CÃ¡mara (camera/frame).</h3>

      <canvas id="cam" width="160" height="120"></canvas>
      <p id="camInfo"></p>
    </section>

  </div>

  <script>
  /* ============================================================
     VISUALIZADOR DE CÃMARA (camera/frame con RGB565)
  ============================================================ */
  const canvas = document.getElementById("cam");
  const ctx = canvas.getContext("2d");
  const W = 160, H = 120;

bus.subscribe("camera/frame", (payload) => {
    let msg=payload;

    const w = msg.w;
    const h = msg.h;
    const b64 = msg.frame_b64;

    // --- Decodificar base64 a Uint8Array ---
    const binary = atob(b64);      // decodifica base64 â†’ string binario
    const u8 = new Uint8Array(binary.length);

    for (let i = 0; i < binary.length; i++) {
        u8[i] = binary.charCodeAt(i);
    }

    // --- Convertir RGB565 â†’ RGBA ---
    const img = ctx.createImageData(w, h);
    const data = img.data;

    for (let i = 0; i < u8.length; i += 2) {
        const rgb565 = (u8[i] << 8) | u8[i+1];
        const r = ((rgb565 >> 11) & 0x1F) << 3;
        const g = ((rgb565 >> 5) & 0x3F) << 2;
        const b = (rgb565 & 0x1F) << 3;

        const idx = (i >> 1) * 4;
        data[idx]   = r;
        data[idx+1] = g;
        data[idx+2] = b;
        data[idx+3] = 255;
    }

    ctx.putImageData(img, 0, 0);

    document.getElementById("camInfo").textContent =
        `Frame RGB565 ~ ${u8.length} bytes (${w}x${h})`;
});


  </script>





 
 
</body>
</html>

